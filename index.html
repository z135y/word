<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>專業直向作文抄寫產生器 (垂直流向修正版)</title>
    <style>
        :root {
            /* 業界稿紙標準顏色：經典綠色 */
            --paper-grid-color: #2e7d32; 
            --cell-size: 50px; 
            --rows-per-col: 6; /* 每列字數 (垂直) */
            --bg-color: #f4f7f6;
        }

        * { box-sizing: border-box; -webkit-print-color-adjust: exact; }

        body { 
            font-family: "標楷體", "BiauKai", "DFKai-SB", serif; 
            padding: 30px; 
            background: var(--bg-color); 
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            writing-mode: horizontal-tb; /* 主頁面維持橫向以堆疊區塊 */
        }

        /* 操作面板樣式 */
        .ui-panel { 
            background: white; 
            padding: 25px; 
            border-radius: 12px; 
            margin-bottom: 40px; 
            box-shadow: 0 4px 25px rgba(0,0,0,0.08); 
            width: 100%;
            max-width: 1000px;
        }

        .ui-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--paper-grid-color);
            margin-bottom: 15px;
            border-left: 5px solid var(--paper-grid-color);
            padding-left: 10px;
        }

        /* 直排輸入框：強化直書語感 */
        textarea { 
            width: 100%; 
            height: 200px;
            padding: 20px; 
            border: 1.5px solid #ced4da; 
            border-radius: 8px; 
            font-size: 22px;
            font-family: inherit;
            writing-mode: vertical-rl; 
            text-orientation: upright;
            line-height: 1.8;
            background: #fffdf9;
            outline: none;
        }
        
        textarea:focus { border-color: var(--paper-grid-color); }

        .config-bar {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .config-item { display: flex; align-items: center; gap: 8px; font-weight: bold; color: #444; }

        input[type="number"], input[type="range"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .btn-group {
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        button { 
            padding: 12px 35px; 
            cursor: pointer; 
            border: none; 
            border-radius: 6px; 
            font-weight: bold; 
            font-size: 16px;
            background: var(--paper-grid-color);
            color: white;
            transition: opacity 0.2s;
        }
        
        button:hover { opacity: 0.9; }

        /* 稿紙顯示容器 */
        #main-container {
            display: flex;
            flex-direction: column;
            gap: 50px;
            width: 100%;
            align-items: center;
        }

        .page-block {
            background: white;
            padding: 50px 70px;
            box-shadow: 0 0 30px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            align-items: flex-end; 
            page-break-after: always;
            border: 1px solid #dee2e6;
        }

        .area-label {
            font-size: 15px;
            color: #666;
            margin-bottom: 12px;
            padding-right: 15px;
            border-right: 4px solid var(--paper-grid-color);
            text-align: right;
            width: 100%;
            font-weight: bold;
        }

        /* 稿紙網格：核心直排書寫邏輯 */
        .manuscript-grid {
            display: grid;
            writing-mode: vertical-rl; /* 文字直排：上至下，右至左 */
            text-orientation: upright;
            /* 在 vertical-rl 下，inline 軸是垂直的，所以用 columns 定義高度 */
            grid-template-columns: repeat(var(--rows-per-col), var(--cell-size));
            /* Block 軸是水平的，定義換列的寬度 */
            grid-auto-rows: var(--cell-size);
            grid-auto-flow: row; /* 先在垂直方向填滿，再橫向換列 */
            border-top: 2.5px solid var(--paper-grid-color);
            border-right: 2.5px solid var(--paper-grid-color);
            background: white;
        }

        .cell {
            width: var(--cell-size);
            height: var(--cell-size);
            border-bottom: 1px solid var(--paper-grid-color);
            border-left: 1px solid var(--paper-grid-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: calc(var(--cell-size) * 0.7);
            position: relative;
        }

        .cell::after {
            content: "";
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(to right, rgba(46, 125, 50, 0.1) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(46, 125, 50, 0.1) 1px, transparent 1px);
            background-position: center;
            background-size: 100% 100%;
            pointer-events: none;
        }

        .spacer { height: 60px; width: 100%; position: relative; }
        .spacer::before { content: ""; position: absolute; top: 50%; left: 0; width: 100%; border-top: 1px dashed #ced4da; }

        @media print {
            .ui-panel { display: none; }
            body { background: white; padding: 0; }
            .page-block { box-shadow: none; border: none; margin: 0; padding: 20px; }
            #main-container { gap: 0; }
        }
    </style>
</head>
<body>

<div class="ui-panel">
    <div class="ui-title">專業直向作文抄寫產生器 (上至下書寫模式)</div>
    
    <textarea id="textInput" oninput="sync()" placeholder="在此輸入文字...">文字由上而下
由右向左換列
請選擇列字數
方便抄寫練習</textarea>
    
    <div class="config-bar">
        <div class="config-item">
            <label for="rowSelect">每列字數 (垂直)：</label>
            <input type="number" id="rowSelect" value="6" min="1" max="30" oninput="sync()">
        </div>
        <div class="config-item">
            <label for="sizeRange">格子大小：</label>
            <input type="range" id="sizeRange" min="30" max="100" value="50" oninput="sync()">
        </div>
    </div>
    
    <div class="btn-group">
        <span id="counter" style="color:#6c757d; font-size:14px;">字數統計：0</span>
        <button onclick="window.print()">儲存為 PDF / 列印</button>
    </div>
</div>

<div id="main-container"></div>

<script>
    function sync() {
        const rawText = document.getElementById('textInput').value;
        const rowsPerCol = parseInt(document.getElementById('rowSelect').value) || 6;
        const cellSize = parseInt(document.getElementById('sizeRange').value) || 50;
        
        const container = document.getElementById('main-container');
        document.getElementById('counter').innerText = `字數統計：${rawText.replace(/\s/g, '').length}`;

        // 動態更新 CSS 變數以控制佈局
        document.documentElement.style.setProperty('--rows-per-col', rowsPerCol);
        document.documentElement.style.setProperty('--cell-size', cellSize + 'px');

        const colsPerPage = 15; 
        const totalCellsPerPage = rowsPerCol * colsPerPage;

        // 換行邏輯處理：補齊垂直剩餘空格以達成換列效果
        let processedText = "";
        const rawLines = rawText.split('\n');
        rawLines.forEach(line => {
            const cleanLine = line.trim();
            if (cleanLine.length > 0) {
                processedText += cleanLine;
                const remainder = cleanLine.length % rowsPerCol;
                if (remainder !== 0) {
                    processedText += " ".repeat(rowsPerCol - remainder);
                }
            } else {
                processedText += " ".repeat(rowsPerCol);
            }
        });

        container.innerHTML = '';
        if (processedText.length === 0) { renderPage("", 1); return; }

        for (let i = 0; i < processedText.length; i += totalCellsPerPage) {
            const chunk = processedText.substring(i, i + totalCellsPerPage);
            renderPage(chunk, Math.floor(i / totalCellsPerPage) + 1);
        }

        function renderPage(content, pageNum) {
            const block = document.createElement('div');
            block.className = 'page-block';

            // 建立示範區
            block.appendChild(createSection(`示範區 (每列 ${rowsPerCol} 字)`, content, true));
            
            // 建立分隔線
            const spacer = document.createElement('div');
            spacer.className = 'spacer';
            block.appendChild(spacer);
            
            // 建立抄寫區 (空網格)
            block.appendChild(createSection(`練習抄寫區`, "", false, content.length));

            container.appendChild(block);
        }

        function createSection(labelText, content, isDemo, minChars = 0) {
            const wrapper = document.createElement('div');
            wrapper.style.display = "flex";
            wrapper.style.flexDirection = "column";
            wrapper.style.alignItems = "flex-end";
            wrapper.style.width = "100%";

            const label = document.createElement('div');
            label.className = 'area-label';
            label.innerText = labelText;
            wrapper.appendChild(label);

            const grid = document.createElement('div');
            grid.className = 'manuscript-grid';
            
            // 計算網格長度
            const targetLength = isDemo ? Math.max(totalCellsPerPage, content.length) : Math.max(totalCellsPerPage, minChars);
            const finalLength = Math.ceil(targetLength / rowsPerCol) * rowsPerCol;

            for (let j = 0; j < finalLength; j++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                const char = content[j];
                cell.innerText = isDemo && char && char !== ' ' ? char : '';
                grid.appendChild(cell);
            }
            
            wrapper.appendChild(grid);
            return wrapper;
        }
    }

    // 初始載入
    window.onload = sync;
</script>

</body>
</html>
